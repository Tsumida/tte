
syntax = "proto3";

package oms;


// 业务枚举统一规范：
//  1. 所有枚举的int32形式和pb enum字段编号一致， 其string形式和字段完全一致. 例: CancelTaker = 1，则1是int32形式，"CancelTaker"是string形式
//  2. 所有枚举均包含UndefinedXXX = 0，仅占位，实际中不采用此枚举
//  3. 所有msg只能用int32, string来表示枚举，并且标记字段对应哪种枚举。不能直接使用enum作为字段类型，避免兼容问题。


enum OrderState{
    UndefinedOrderState = 0;
    New = 1;             
    Rejected = 2;        
    PendingNew = 3;      
    PartiallyFilled = 4; 
    Filled = 5;          
    Cancelled = 6;       
}

enum Direction{
    UndefinedDirection = 0;
    Buy = 1;
    Sell = 2;
}

enum TimeInForce{
    UndefinedTIF = 0;
    GTK = 1;
    FOK = 2;
    IOC = 3;
}

enum OrderType{
    UndefinedOrderType = 0;
    Limit = 1;  
    Market = 2;
}

enum STPStrategy{
    UndefinedSTPStrategy = 0;
    CancelTaker = 1;      // 撤销最老订单
    CancelMaker = 2;      // 撤销最新订单
    CancelBoth = 3;        // 撤销两个订单
}

enum BizAction{
    UndefinedBizAction = 0;
    Deposit = 1;
    Withdraw = 2;
    Transfer = 3;   // 账户间划转
    PlaceOrder = 4;
    ReplaceOrder = 5;
    CancelOrder = 6;
    FillOrder = 7;

    // 100起步是内部控制指令
}

message TradePair{
    string base = 1;   // 基础币种
    string quote = 2;  // 计价币种
}

message Order{
    string order_id = 1; 
    TradePair trade_pair = 2; 
    int32 direction = 3;        // 对应Direction枚举
    int32 time_in_force = 4;    // 对应TimeInForce枚举
    int32 order_type = 5;   // 对应OrderType枚举
    string price = 6;
    string quantity = 7;
    string create_time = 8; // us
    string client_order_id = 9; // 可选
    int32 stp_strategy = 10; // 对应STPStrategy枚举
    uint64 account_id = 11; 
    bool post_only = 12; // true表示只挂单不吃单
    uint64 seq_id = 13; // 创建订单时初始化，此后不变
    uint64 prev_seq_id = 14;
}


message OrderDetail{
    Order original = 1;
    string current_state = 2; // 对应OrderState枚举
    string filled_quantity = 3;
    uint64 last_seq_id = 4;
    uint64 update_time = 5; // us
}

message AdminCmd{

}

message RpcCmd{
    int32 biz_action = 1; // 对应BizAction枚举
    PlaceOrderReq place_order_req = 2; // biz_action为PlaceOrder时有效
    CancelOrderReq cancel_order_req = 3 ; // biz_action为CancelOrder时有效
}

message TradeCmd{
    uint64 seq_id = 1;
    uint64 prev_seq_id = 2;
    int32 msg_types = 3; // bitmask, 1表示RPC, 2表示MatchResult
    RpcCmd rpc_cmd = 4;
    MatchResult match_result = 5;
}

// 撮合结果
message MatchRecord{
    uint64 seq_id = 1;
    uint64 prev_seq_id = 2;
    string price = 3;
    string quantity = 4;
    int32 direction = 5;    // 对应Direction枚举
    string taker_order_id = 6;
    string maker_order_id = 7;
    bool is_taker_fulfilled = 8;
    bool is_maker_fulfilled = 9;
}

message MatchResult{
    Order order = 1;
    repeated MatchRecord records = 2;
}

// ======================================== 账户类
message BalanceItem{
    string currency = 1; // BTC\/USDT等
    string balance = 2; // 总余额, 等于available + frozen
    string available = 3; // 可用于交易
    string frozen = 4; // 冻结余额
    uint64 update_time = 5; // 最后更新时间，us
}

// ======================================== 交易对状态

enum TradePairState{
    UndefinedPairState = 0;
    TradingPair = 1;    // 正常交易
    SuspendedPair = 2;  // 不可交易，但可以撤单
    NewPair = 3;        // 新上线，暂不可交易
}

// ======================================== 配置类
message TradePairConfig{
    string trade_pair = 1;
    string min_price_increment = 2;
    string min_quantity_increment = 3;
    int32 state = 4; // 对应TradePairState枚举
    string volatility_limit = 5; // 价格波动限制百分比，例如0.1表示10%
}

// ======================================= 行情类
message LevelSnapshot{
    string trade_pair = 1; 
    repeated Order bids = 2; 
    repeated Order asks = 3; 
}

// ======================================== 指令类
message ReplaceOrderCmd{
    string order_id = 1; 
    string new_price = 2;
    string new_quantity = 3;
    uint64 account_id = 4;
}

// Generate PlaceOrder, ReplaceOrder, CancelOrder, TakeSnapshot

// ======================================== RPC类
message PlaceOrderReq{
    Order order = 1;
}

message PlaceOrderRsp{
}

message ReplaceOrderReq{    
    ReplaceOrderCmd cmd = 1;
}

message ReplaceOrderRsp{
}

message CancelOrderReq{
    string order_id = 1;
    uint64 account_id = 2;
}

message CancelOrderRsp{
}

message TakeSnapshotReq{
}

message TakeSnapshotRsp{
}

message GetOrderDetailReq{
    string order_id = 1;
    string client_order_id = 2; 
    uint64 account_id = 3;
}

message GetOrderDetailRsp{
    OrderDetail detail = 1;
}

message TransferFreezeReq{
    string transfer_id = 1;
    uint64 account_id = 2;
    string currency = 3;
    string amount = 4;  
}

message TransferFreezeRsp{}

message TransferReq{
    string transfer_id = 1;
    uint64 from_account_id = 2;
    uint64 to_account_id = 3;
    string currency = 4;
    string amount = 5;  
}

message TransferRsp{}

// ======================================== 账户类
message GetBalanceReq{
    uint64 account_id = 1;
}

message GetBalanceRsp{
    uint64 account_id = 1;
    repeated BalanceItem balances = 2;
}

// ======================================== 管理类
message UpdateTradePairConfigReq{
    TradePairConfig config = 1;
}

message UpdateTradePairConfigRsp{
}


// ================================ 业务类
service OMSService {
    rpc PlaceOrder(PlaceOrderReq) returns (PlaceOrderRsp);

    rpc CancelOrder(CancelOrderReq) returns (CancelOrderRsp);

    rpc TransferFreeze(TransferFreezeReq) returns (TransferFreezeRsp);

    rpc Transfer(TransferReq) returns (TransferRsp);

    // 订单查询类
    // 优先按order_id查询，其次按client_order_id查询
    rpc GetOrderDetail(GetOrderDetailReq) returns (GetOrderDetailRsp);

    // Balance类
    rpc GetBalance(GetBalanceReq) returns (GetBalanceRsp);

    // 内部使用
    rpc TakeSnapshot(TakeSnapshotReq) returns (TakeSnapshotRsp);
    rpc UpdateTradePairConfig(UpdateTradePairConfigReq) returns (UpdateTradePairConfigRsp);
}