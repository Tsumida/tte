# --- é˜¶æ®µ 1: Builder (ç¼–è¯‘é˜¶æ®µ) ---
# ä½¿ç”¨ clux/muslrust é•œåƒã€‚
FROM clux/muslrust:1.91.1-stable-2025-11-26 AS builder

# å·¥ä½œç›®å½•
WORKDIR /home/rust/src

# 1. å¤åˆ¶æ‰€æœ‰å·¥ä½œç©ºé—´æ‰€éœ€çš„æ–‡ä»¶
# å¤åˆ¶é¡¶å±‚çš„ Cargo.toml å’Œ Cargo.lock
COPY Cargo.toml Cargo.lock ./
# å¤åˆ¶æ‰€æœ‰ crate çš„ Cargo.tomlï¼Œè¿™æ˜¯æ„å»ºä¾èµ–æ‰€å¿…éœ€çš„
COPY crates/*/Cargo.toml crates/

# 2. **å…³é”®ä¼˜åŒ–ï¼šä¾èµ–é¡¹ç¼“å­˜å±‚**
# åœ¨å·¥ä½œç©ºé—´ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ --workspace æ¥ç¼–è¯‘æ‰€æœ‰ä¾èµ–
RUN mkdir -p src/ && echo "fn main() {}" > src/main.rs && \
    cargo build --release --workspace || true && \
    rm -rf src/

# 3. å¤åˆ¶æ‰€æœ‰åº”ç”¨ç¨‹åºæºä»£ç  (åŒ…æ‹¬æ‰€æœ‰ crates ç›®å½•)
COPY . .

# 4. **æœ€ç»ˆç¼–è¯‘** (åªéœ€ç¼–è¯‘æœ¬åœ°ä»£ç )
# ğŸ¯ æŒ‡å®šè¦ç¼–è¯‘çš„äºŒè¿›åˆ¶ crate: 'server'
RUN cargo build --release --package tte-server --bin mvp_server

# --- é˜¶æ®µ 2: Final (æœ€ç»ˆé•œåƒ) ---
# ä¿æŒä¸å˜ï¼Œä½¿ç”¨æœ€å°åŒ–çš„ Alpine
FROM alpine:3.20.8

# æœ€ç»ˆé•œåƒçš„å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ¯ ä» builder é˜¶æ®µå¤åˆ¶ç¼–è¯‘å¥½çš„é™æ€äºŒè¿›åˆ¶æ–‡ä»¶
# --bin server ç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶åé»˜è®¤ä¸º crate åç§° 'server'
COPY --from=builder /home/rust/src/target/x86_64-unknown-linux-musl/release/mvp_server /app/mvp_server

# ç¡®ä¿ Alpine ä¸­åŒ…å«è¿è¡Œ librdkafka å¯èƒ½éœ€è¦çš„ CA è¯ä¹¦
RUN mkdir -p /app/snapshot && apk update && apk add --no-cache ca-certificates

# ç¯å¢ƒå˜é‡ (å‡è®¾ server crate å¯¹åº”ä½ åŸæ¥çš„ OMS è§’è‰²)
ENV RUST_LOG=info \
    ENV=dev \
    SERVER_MODE=oms \
    GRPC_SERVER_ENDPOINT=[::1]:8080 \
    TRACE_ENDPOINT=http://localhost:4318

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
# ğŸ¯ è¿è¡Œæ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ 'server'
ENTRYPOINT ["/app/mvp_server"]