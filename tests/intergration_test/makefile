# ==============================================================================
# ðŸ³ Docker é•œåƒé…ç½®
# ==============================================================================

# Server (åŽŸ mvp_server, çŽ° crates/server)
IMAGE_NAME := mvp_server
IMAGE_TAG := latest
DOCKERFILE_SERVER := Dockerfile.server


# ==============================================================================
# ðŸ’¾ å¿«ç…§é…ç½®
# ==============================================================================
SS_DIR := ./snapshot
# æ³¨æ„: å®¹å™¨åç§°åº”è¯¥ä¸Žä½ å®žé™…è¿è¡Œçš„ docker-compose æˆ– run å‘½ä»¤ä¸­çš„åç§°ä¿æŒä¸€è‡´
OMS_CONTAINER := mvp_server
ME_CONTAINER := mvp_me
CONTAINER_SS_PATH := /app/snapshot
TIMESTAMP := $(shell date +%Y%m%d_%H%M%S)

# ==============================================================================
copy-snapshot:
	@mkdir -p "$(SS_DIR)/$(TIMESTAMP)/server" && mkdir -p "$(SS_DIR)/$(TIMESTAMP)/me"
	@echo "==> Copying Server snapshots from $(OMS_CONTAINER) ..."
	-@docker cp $(OMS_CONTAINER):"$(CONTAINER_SS_PATH)/" "$(SS_DIR)/$(TIMESTAMP)/server/" || echo "No Server snapshots found in $(OMS_CONTAINER)."
	@echo "==> Copying ME snapshots from $(ME_CONTAINER) ..."
	-@docker cp $(ME_CONTAINER):"$(CONTAINER_SS_PATH)/" "$(SS_DIR)/$(TIMESTAMP)/me/" || echo "No ME snapshots found in $(ME_CONTAINER)." 	
	@echo "==> Done. Files copied to $(SS_DIR)/$(TIMESTAMP)"

inter-test:
	@echo "Waiting for services to start..." 
	@docker-compose up -d --abort-on-container-exit; sleep 5
	@echo "Running integration tests"
	@../../target/debug/mvp_client ./place_order.case
	@$(MAKE) copy-snapshot
	@docker-compose stop

.PHONY: inter-test copy-snapshot